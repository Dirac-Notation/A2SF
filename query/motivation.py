import torch
import matplotlib.pyplot as plt

from transformers import AutoModelForCausalLM, AutoTokenizer
from transformers.models.llama.modeling_llama import apply_rotary_pos_emb

# 모델과 토크나이저 로드
model_name = "togethercomputer/Llama-2-7B-32K-Instruct"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    torch_dtype=torch.float16,
    device_map="auto"
)

# Hook으로 저장할 텐서들
prerope_queries = {}
postrope_queries = {}

prerope_keies = {}
postrope_keies = {}

hook_handles = []

def make_hook(layer_idx, attn_module, op_type):
    num_heads = getattr(attn_module, "num_heads", None)
    head_dim  = getattr(attn_module, "head_dim", None)
    rotary    = getattr(attn_module, "rotary_emb", None)

    def hook_fn(module, inputs, output):
        tmp = output
        
        bsz, seqlen, _ = tmp.shape

        if op_type == "q":
            prerope_queries[layer_idx] = tmp.view(bsz, seqlen, num_heads, head_dim).transpose(1, 2).detach().to("cpu")
        elif op_type == "k":
            prerope_keies[layer_idx] = tmp.view(bsz, seqlen, num_heads, head_dim).transpose(1, 2).detach().to("cpu")

        tmp = tmp.view(bsz, seqlen, num_heads, head_dim).transpose(1, 2)
        position_ids = torch.arange(seqlen, device=tmp.device)[None,:].to(tmp.device)

        cos, sin = rotary(tmp, position_ids)
        tmp_rope, _ = apply_rotary_pos_emb(tmp, tmp, cos, sin)

        if op_type == "q":
            postrope_queries[layer_idx] = tmp_rope.detach().to("cpu")
        elif op_type == "k":
            postrope_keies[layer_idx] = tmp_rope.detach().to("cpu")

    return hook_fn

def cross_cosine_similarity(v1, v2):
    if v1.ndim != 4 or v2.ndim != 4:
        raise ValueError("v1 and v2 must be a 4D tensor")
    
    if v1.device == torch.device("cpu"):
        v1 = v1.to("cuda")
    if v2.device == torch.device("cpu"):
        v2 = v2.to("cuda")

    
    inner_product = torch.matmul(v1, v2.transpose(2, 3)).to("cpu")
    v1_norm = torch.norm(v1, dim=3, keepdim=True)
    v2_norm = torch.norm(v2, dim=3, keepdim=True)
    v1_cross_norm = torch.matmul(v1_norm, v2_norm.transpose(2, 3)).to("cpu")
    cross_cosine_sim = inner_product / v1_cross_norm
    
    return cross_cosine_sim

def plot_vector(v):
    plt.figure(figsize=(10, 10))
    plt.plot(v)
    plt.savefig("temp.png")
    plt.close()

# 레이어별로 q_proj에 훅 등록
for layer_idx in range(model.config.num_hidden_layers):
    attn = model.model.layers[layer_idx].self_attn
    
    handle_q = attn.q_proj.register_forward_hook(make_hook(layer_idx, attn, "q"))
    handle_k = attn.k_proj.register_forward_hook(make_hook(layer_idx, attn, "k"))
    
    hook_handles.append(handle_q)
    hook_handles.append(handle_k)

# 입력 텍스트
# text = "Answer the question based on the given passages. Only give me the answer and do not output any other words.\n\nThe following are given passages.\nPassage 1:\nTrusty system (prison)\nThe \"trusty system\" (sometimes incorrectly called \"trustee system\") was a penitentiary system of discipline and security enforced in parts of the United States until the 1980s, in which designated inmates were given various privileges, abilities, and responsibilities not available to all inmates.It was made compulsory under Mississippi state law but was used in other states as well, such as Arkansas, Alabama, Louisiana, New York and Texas. The method of controlling and working inmates at Mississippi State Penitentiary at Parchman was designed in 1901 to replace convict leasing. The case Gates v. Collier ended the flagrant abuse of inmates under the trusty system and other prison abuses that had continued essentially unchanged since the building of the Mississippi State Penitentiary. Other states using the trusty system were also forced to give it up under the ruling.\n\nHistory\nPrisons had trusties as far back as the 1800s.\n\nParchman Farm\nThe prison had approximately 16,000 acres (65 km2) of farmland and grew such cash crops as cotton as well as engaged in livestock production. Although the population of the prison was around 1,900 inmates (two thirds of whom were black and in racially-segregated units), the law allowed only a maximum of 150 staff members to be hired to minimize operating costs. Thus, the farm labor was done by inmates.The bulk of guarding and disciplining of the inmates was performed by inmate trusties. They also performed most of the administrative work, supervised by a few employees. Therefore, the inmate trusties essentially controlled inmate care and custody, basically running the prison system.Highest in the prison inmate hierarchy were the inmates armed with rifles, called the \"trusty shooters\". Their job was to act as prison guards and control other inmates on a day-to-day basis in the residential camps or out on the field work crews. Next came the unarmed trusties who performed janitorial, clerical, and other menial tasks for the prison's staff. Simple tasks, such as distributing medication, were carried out by other categories of inmates such as \"hallboys\". Inmate trusties enforced discipline within the prison inmate living quarters (16 different residential camps) and in the work camps and prison farms. In addition to punishment administered on site, inmate trusties could recommend further punishment in the special punishment area for disobedient or disruptive inmates.According to attorney Roy Haber, who handled the series of litigation cases brought by the American Civil Liberties Union against the trusty system, inmates were whipped with leather straps for failing to pick their daily quota of cotton. The farm's camps of black inmates were supervised by one white sergeant, and under him the black inmate \"trusty shooters\", who were serving sentences for murder, carried rifles and enforced discipline.\n\nAbolition\nGates v. Collier (Gates v. Collier Prison Reform Case, 1970–1971) ended the flagrant abuse of inmates under the trusty system and other prison abuses that had continued essentially unchanged since the building of the prison in 1903. On October 20, 1972, Federal Judge William Keady ordered the end of racial segregation in prison residential quarters. He also required replacement of trusty shooters with civilian prison guards.Any system in which inmates were allowed to be in a position of authority and control other inmates or to use physical abuse or intimidation of other inmates was abolished. It also found some types of corporal punishment were a violation of an inmate's Eighth Amendment rights, including \"handcuffing inmates to the fence and to cells for, long periods of time,... and forcing inmates to stand, sit or lie on crates, stumps, or otherwise maintain awkward positions for prolonged periods.\"Its structure and abuses were detailed in Hope v. Pelzer in which a former inmate sued the prison superintendent for personal injury suffered under the trusty system.Other states using the trusty system, such as Arkansas, Alabama, Louisiana, and Texas were also forced to abolish it under the Gates v. Collier rulings. However, some states, such as Texas, still continued their use of trusty systems (known as \"building tenders\") until the 1980s, when Federal Judge William Wayne Justice, in Ruiz v. Estelle, 503 F. Supp. 1265 (S.D. Tex. 1980), compelled the replacement of the trusty system with the strictly-regulated Support Service Inmate (SSI) system.\n\nSee also\n\"Parchman Farm\" (song)\nLouisiana State Penitentiary\nKapo\nPassage 2:\nBrockmeyer v. Dun &amp; Bradstreet\nBrockmeyer v. Dun & Bradstreet 113 Wis. 2d 561, 335 N.W.2d 834 (Wis. 1983), was a case in which the Wisconsin Supreme Court first identified that Wisconsin has some judicial exceptions to the employment at will doctrine.\n\nFacts\nCharles J. Brockmeyer was employed at investment firm Dun & Bradstreet as a district manager of credit services, though he lacked a formal employment contract. After the employer settled a sex discrimination suit filed by the employee's former secretary, with whom he allegedly had an affair, the employer fired the employee. The court held that it was appropriate to create a public policy exception to the employment-at-will doctrine, as the termination had clearly violated a well-defined public policy, as evidenced by existing law. While the employer's actions may have constituted bad faith, they did not contravene the policies of any statute or constitutional provision. As the employee failed to prove that his discharge violated fundamental public policy, the decision for the employer was appropriate.\n\nHolding\nThe court affirmed the decision of the lower court in favor of the employer.\n\nCitations\nThe case is cited in Bammert v. Don's Super Valu, Inc.\nPassage 3:\nMiller v. California\nMiller v. California, 413 U.S. 15 (1973), was a landmark decision of the U.S. Supreme Court modifying its definition of obscenity from that of \"utterly without socially redeeming value\" to that which lacks \"serious literary, artistic, political, or scientific value\". It is now referred to as the three-prong standard or the Miller test.\n\nBackground\nIn 1971, Marvin Miller, an owner/operator of a California mail-order business specializing in pornographic films and books, sent out a brochure advertising books and a film that graphically depicted sexual activity between men and women. The brochure used in the mailing contained graphic images from the books and the film. Five of the brochures were mailed to a restaurant in Newport Beach, California. The owner and his mother opened the envelope and seeing the brochures, called the police.Miller was arrested and charged with violating California Penal Code 311.2(a) which says in part, \"Every person who knowingly sends or causes to be sent, or brings or causes to be brought, into this state for sale or distribution, or in this state possesses, prepares, publishes, produces, or prints, with intent to distribute or to exhibit to others, or who offers to distribute, distributes, or exhibits to others, any obscene matter is for a first offense, guilty of a misdemeanor.\" California lawmakers wrote the statute based on two previous Supreme Court obscenity cases, Memoirs v. Massachusetts and Roth v. United States.Miller was tried by jury in the Superior Court of Orange County. At the conclusion of the evidence phase, the judge instructed the jury to evaluate the evidence by the community standards of California, i.e., as defined by the statute. The jury returned a guilty verdict.\nMiller appealed to the Appellate Division of the Superior Court, arguing that the jury instructions did not use the standard set in Memoirs v. Massachusetts which said that in order to be judged obscene, materials must be \"utterly without redeeming social value.\" Miller argued that only a national standard for obscenity could be applied. The appellate division rejected the argument and affirmed the jury verdict. Miller then filed an appeal with the California Court of Appeal for the Third District, which declined to review. Miller applied to the Supreme Court for certiorari, which was granted. Oral arguments were heard in January 1972.\n\nPrevious Supreme Court decisions on obscenity\nThe U.S. Supreme Court granted certiorari to Miller because the California law was based on its two previous obscenity cases which the Court wanted to revisit. Chief Justice Warren Burger came to the Court in 1969 believing that the Court's obscenity jurisprudence was misguided and governments should be given more leeway to ban obscene materials. In consideration of Miller in May and June 1972, Burger pushed successfully for a looser definition of \"obscenity\" which would allow local prosecutions, while Justice William J. Brennan, Jr., who by now also believed the Roth and Memoirs tests should be abandoned, led the charge for protecting all \"obscenity\" unless distributed to minors or exposed offensively to unconsenting adults. Decision of the case was contentious, and Miller was put over for reargument for October term in 1972, and did not come down until June 1973, with Burger prevailing with a 5–4 vote.Since the Court's decision in Roth v. United States, the Court had struggled to define what constituted constitutionally unprotected obscene material. Under the Comstock laws that prevailed before Roth, articulated most famously in the 1868 English case Regina v Hicklin, any material that tended to \"deprave and corrupt those whose minds are open to such immoral influences\" was deemed \"obscene\" and could be banned on that basis. Thus, works by Honoré de Balzac, Gustave Flaubert, James Joyce, and D. H. Lawrence were banned based on isolated passages and the effect they might have on children. Roth repudiated the \"Hicklin test\" and defined obscenity more strictly, as material whose \"dominant theme taken as a whole appeals to the prurient interest\" to the \"average person, applying contemporary community standards\". Only material now meeting this test could be banned as \"obscene\".In Memoirs v. Massachusetts, a plurality of the Court further redefined the Roth test by holding unprotected only that which is \"patently offensive\" and \"utterly without redeeming social value,\" but no opinion in that case could command a majority of the Court either, and the state of the law in the obscenity field remained confused.  In Jacobellis v. Ohio, Justice Potter Stewart's concurring opinion said that the Court in earlier pornography cases \"was faced with the task of trying to define what may be indefinable,\" and that criminal laws were constitutionally limited to \"hard-core pornography,\" which he did not try to define: \"perhaps I could never succeed in intelligibly doing so. But I know it when I see it.\" Other Justices  had equally been unwilling to clearly define what pornography could be prohibited by the First Amendment.\n\nSupreme Court decision\nMiller had based his appeal in California on Memoirs v. Massachusetts. The Court rejected that argument.\nThe question before the court was whether the sale and distribution of obscene material was protected under the First Amendment's guarantee of Freedom of Speech. The Court ruled that it was not. It indicated that \"obscene material is not protected by the First Amendment,\" especially that of hardcore pornography, thereby reaffirming part of Roth.However, the Court acknowledged \"the inherent dangers of undertaking to regulate any form of expression,\" and said that \"State statutes designed to regulate obscene materials must be carefully limited.\" The Court, in an attempt to set such limits, devised a set of three criteria which must be met for a work to be legitimately subject to state regulation:\n\nwhether the average person, applying contemporary \"community standards,\" would find that the work, taken as a whole, appeals to the prurient interest;\nwhether the work depicts or describes, in an offensive way, sexual conduct or excretory functions, as specifically defined by applicable state law (the syllabus of the case mentions only sexual conduct, but excretory functions are explicitly mentioned on page 25 of the majority opinion); and\nwhether the work, taken as a whole, lacks serious literary, artistic, political, or scientific value.This obscenity test overturns the definition of obscenity set out in the Memoirs decision, which held that \"all ideas having even the slightest redeeming social importance ... have the full protection of the guaranties [of the First Amendment]\" and that obscenity was that which was \"utterly without redeeming social importance\".The Miller decision vacated the jury verdict and remanded the case back to the California Superior Court.\n\nDefinition of obscenity post-Miller\nMiller provided states greater freedom in prosecuting alleged purveyors of \"obscene\" material because, for the first time since Roth, a majority of the Court agreed on a definition of \"obscenity.\" Hundreds of \"obscenity\" prosecutions went forward after Miller, and the Supreme Court began denying review of these state actions after years of reviewing many \"obscenity\" convictions (over 60 appeared on the Court's docket for the 1971–72 term, pre-Miller).A companion case to Miller, Paris Adult Theatre I v. Slaton, provided states with greater leeway to shut down adult movie houses. Controversy arose over Miller's \"community standards\" analysis, with critics charging that Miller encouraged forum shopping to prosecute national producers of what some believe to be \"obscenity\" in locales where community standards differ substantially from the rest of the nation. For example, under the \"community standards\" prong of the Miller test, what might be considered \"obscene\" in Utah might not be considered \"obscene\" in Massachusetts, or the opposite might be true; in any event, prosecutors tend to bring charges in locales where they believe that they will prevail. Justice Brennan, author of the Roth opinion, argued in his dissent for Paris Adult Theatre that outright suppression of obscenity is too vague to enforce in line with the First and Fourteenth Amendments.The standards established by Miller were elaborated upon in Pope v. Illinois in 1987. In the case, the jury instructions for the local court had been for the jurors to evaluate whether adult magazines had value according to a community standard, and the conviction was held by the Illinois appellate court. The Supreme Court overruled the appellate court decision, siding with the defendant. In the majority opinion, the Supreme Court held that the first two prongs of the test were to be evaluated according to a \"community standard,\" but not the third, which was to be held to the higher standard of a \"reasonable person\" evaluating the work for value.In 1987, Oregon became the first state to strike down the criminalization of obscenity. In State v. Henry, the Oregon Supreme Court ruled in favor of Earl Henry, the owner of an adult bookstore, stating that the state obscenity statute violated the free speech provision of Oregon's state constitution.In 1997, the Supreme Court ruled in Reno v. American Civil Liberties Union that the anti-indecency provisions of the Communications Decency Act were unconstitutional. The Act had criminalized the sending of \"obscene or indecent\" material to minors over the Internet. The court unanimously ruled that the provision violated the First Amendment due to its burden on free speech.\n\nEffects of the decision\nIn the years since Miller, many localities have cracked down on adult theatres and bookstores, as well as nude dancing, through restrictive zoning ordinances and public nudity laws.Additionally, in 1982's New York v. Ferber the Court declared child pornography as unprotected by the First Amendment, upholding the state of New York's ban on that material. In the 2002 Ashcroft v. Free Speech Coalition case, however, the Court held that sexually explicit material that only appears to depict minors, but actually does not, might be exempt from obscenity rulings.In American Booksellers Foundation for Free Expression v. Strickland, plaintiffs American Booksellers Foundation for Free Expression, joined by various publishers, retailers, and web site operators, sued Ohio's Attorney General and Ohio county prosecutors in United States District Court for the Southern District of Ohio. Plaintiffs alleged that Ohio Revised Code §2907.01(E) and (J), which prohibited the dissemination or display of \"materials harmful to juveniles\", unconstitutionally violated both the First Amendment and the Commerce Clause of the Constitution. Plaintiffs specifically challenged the statute's definition of \"harmful to juveniles\", as well as the provisions governing Internet dissemination of those materials. The court held the statute unconstitutional because the statute's definition of \"material harmful to minors\" did not comply with Miller.The \"community standards\" portion of the decision is of particular relevance with the rise of the Internet, as materials believed by some to be \"obscene\" can be accessed from anywhere in the nation, including places where there is a greater concern about \"obscenity\" than other areas of the nation. Enforcing and applying obscenity laws to the Internet have proven difficult. Both the Child Pornography Prevention Act (CPPA) and the Child Online Protection Act (COPA) have had sections struck down as unconstitutional in cases such as Ashcroft v. Free Speech Coalition and Ashcroft v. ACLU.\n\nSee also\nList of United States Supreme Court cases, volume 413\nSex-related court cases\nUnited States obscenity law\nPassage 4:\nGasser v MISAT\nGasser v MISAT (C–116/02) was a decision of the European Court of Justice regarding the interpretation of the Brussels convention of 1968 ruling that a court chosen in a choice of court agreement should stay its proceedings - as any other court chosen second within the Brussels regime - until the court first seized had declared it did not have jurisdiction. The court's decision was considered problematic as it favoured the uniformity of application of the Brussels regime jurisdictional rules temporarily over party autonomy.: 572  Due to similar provisions in the 2001 Brussels Regulation and Lugano Conventions, the interpretation also affects choice of court agreements under those later instruments. However, in the 2012 Recast version of the Brussels I Regulation chosen courts can take jurisdiction, even if a court not chosen has been addressed first.\n\nFacts\nAustrian supplier Gasser and Italian distributor MISAT entered into a contract together for the supply of children's clothes. In the contract, they included a choice-of-court agreement, stipulating that an Austrian court have jurisdiction in case of conflict. However, when a dispute arose between the two parties, MISAT seised an Italian court to declare that the contract had been terminated, contrary to the choice-of-court clause they agreed on.\nMISAT relied on Article 21 of the Brussels Convention, a convention to which all members of the European Community were party, and which regulates which court within those states has jurisdiction. The convention contains a lis alibi pendens-rule: where proceedings involving the same issue and between the same parties are brought before the courts of different Member States, the court seised second must stay proceedings up until the jurisdiction of the court first seised has been established – after which the court second seised must decline jurisdiction if the court first seised is indeed found to have jurisdiction. Consequently, Article 21 of the Convention establishes a type of \"first come, first served\"-rule: when there is a triple identity in parties,: §34  object,: §40  as well as cause of action, the court that has been seised second will only be able to decide in the case when it has been decided in the first court that the latter has no jurisdiction. The Report Jenard cites the need to \"facilitate the proper administration of justice within the Community\" as the underlying idea behind this lis alibi pendens rule, as irreconcilable judgments would obstruct such proper administration and ultimately be detrimental to the \"mutual trust in the administration of justice in the Community\". Consequently, the lis pendens-rule can be considered as an expression of the Regulation's search for both certainty and the preservation of mutual trust amongst Member States.The problem however in the case at hand was that the parties had first made an agreement as to which court would have jurisdiction in case of conflict- namely an Austrian court. Consequently, Gasser brought the same case before the Oberlandesgericht (Higher Regional Court) Innsbruck in Austria, where the question was eventually passed on to the European Court of Justice of whether or not the lis pendens-rule could override the parties' autonomous decision contained in their choice-of-court agreement and thus, if the abovementioned rule contained in Article 21 of the Convention was applicable or not.: §21, §28\n\nCJEU procedure\nThe reference for a preliminary ruling were made on 25 March 2002, and observations were made -in addition to the parties in the dispute- by Italy, the United Kingdom and the European Commission. While Italy, the Commission and Misat contended that the lis pendens doctrine needed to take precedence, and that thus the court second seized should stay its proceedings until the first court had decided on its position, the UK and Gasser argued that the choice of the parties should take immediate precedence over the lis pendens rule.\n\nAdvocate-General\nThe (advisory) opinion of Advocate-General was delivered on 9 September 2003. The Advocate-general held that the European Court of Justice had the possibility to rule that a valid choice of court clause amounted exclusive jurisdiction to a (group of) courts, and that thus it was possible to derogate from using the lis pendens doctrine and give such a court immediate jurisdiction. The court had made a similar exception before in Overseas Union Insurance Ltd and Deutsche Ruck Uk Reinsurance Ltd and Pine Top Insurance Company Ltd v New Hampshire Insurance Company where it ruled that if one of the \"exclusive jurisdiction\" grounds of Article 16 applied, the court that had exclusive jurisdiction did not have to stay proceedings, even if it was seized second. The exclusive jurisdiction of choice of court agreements/clauses is however placed in Article 15, and thus is not automatically covered by the judgments. The Advocate general suggested to only allow a court seized second (and which was chosen in a choice of court clause/agreement) \"where there is no room for any doubt as to the jurisdiction of the court second seised\"; to avoid the situations where both courts would assume jurisdiction.\n\nDecision\nThe Court resolutely rejected the possibility that the party autonomy could take precedence over the abovementioned goals of certainty and mutual trust, stating that \"the court second seised is never in a better position than the court first seised to determine whether the latter has jurisdiction\".: §48  Even though the Austrian court was consistent with the parties choice-of-court agreement, it was for the court first seized to decide it had not jurisdiction and the presence of such a clause is \"not such as to call in question the application of the procedural rule contained in Article 21 of the Convention [now Article 27], which is based clearly and solely on the chronological order in which the courts involved are seised\".: §46–47\n\nRelevance\nThe ruling by the Court has implications not only for the application of the Brussels Convention, but also by the Brussels I Regulation (44/2001) that mostly replaced it, and for the interpretation by EU states of the Lugano Conventions of 1998 and 2007 that contain similar provisions.: 572 First, there is the (unlikely) risk that the court first seised finds the jurisdiction clause invalid, which consequently takes away the possibility for the designated court to decide the case, even if the latter would have declared the clause valid.: 577  Although the Court in Gasser first seems to minimise the likelihood of this hypothesis by stating that a jurisdiction clause \"must be regarded as an independent concept\",: §51  it nonetheless points out that verifying the existence of jurisdiction clauses \"may necessitate delicate and costly investigations\".: §26  As a result, although unlikely, there is still a risk that two courts from different Member States will decide upon the validity of a jurisdiction clause differently.: 572 Second, the Court's ruling, which imposes a sort of absolute first-come, first-served principle, promotes the use of tactical litigation and \"torpedo claims\".: 573  The reason why can be described as the difference between theory and reality. In theory, the fact that a party would have to turn to a different Member State for a ruling in his case is irrelevant or even meaningless, as the Brussels I Regulation rests upon the axiomatic assumption that procedural justice is served wherever in the community proceedings are heard.: 570  In reality however, this fact is of great tactical significance to the recalcitrant party, since -apart from the aforementioned fact that the first court seised may determine the effect of Article 23 differently- some Member States have a system of much slower-moving judiciary, which makes the realisation of procedural justice unlikely.: 577  Italy is a prime example thereof, with decisions on jurisdiction alone taking several months or even years; commencing proceedings in Italy is accordingly dubbed \"firing the Italian torpedo\". This torpedo may well sink a jurisdiction agreement, as the crude confrontation with increased delay and expense for the other party makes it not only unlikely for him to recommence proceedings in the agreed court after jurisdiction has been settled, but can even deter him from litigating altogether at the sight of the location of the court first seised.: 577 In conclusion, not only may the party defending the choice-of-court agreement experience substantive disadvantages in the other Member State, as the court situated there might declare the agreement invalid, the party may also be exposed to procedural disadvantages, caused by judicial system which is not chosen.: 573  This in turn can make the jurisdiction agreement ineffective altogether, going against the principle of party autonomy. Taking a formalistic and literal approach, the Court states that \"the difficulties of the kind (...) stemming from delaying tactics by parties (...) are not such as to call in question the interpretation of the Brussels Convention, as deduced from its wordings and purpose\",: §53  pointing out that the Regulation \"is necessarily based on the trust which Contracting States accord to each other's legal systems and judicidial institutions\".: §72\n\nEffect on the Brussels Regulation\nIn the Recast of the Brussels I Regulation, the Commission addressed the problems created by the Gasser judgment. Dealing with the problematic tactical litigation spawning from the Gasser judgment, the Recast Regulation now contains a reversal of the priority rule, by giving the court chosen by the parties in the jurisdiction agreement precedence over all other courts, regardless of when proceedings were initiated. From a prima facie point of view, this certainly seems to deal the Gasser problem effectively, as a tactical race to the court is now without effect. However, some have raised the question to whether or not this will simply encourage the use of 'sham jurisdictional agreements', and if this indisputable preference for allegedly-chosen courts could not just lead to “improved” or “reverse” torpedo claims.\nPassage 5:\nAdams v. Burke\nAdams v. Burke, 84 U.S. (17 Wall.) 453 (1873), was a United States Supreme Court case in which the Court first elaborated on the exhaustion doctrine. According to that doctrine, a so-called authorized sale of a patented product (one made by the patentee or a person authorized by it to sell the product) liberates the product from the patent monopoly. The product becomes the complete property of the purchaser and \"passes without the monopoly.\" The property owner is then free to use or dispose of it as it may choose, free of any control by the patentee. Adams is a widely cited, leading case. A substantially identical doctrine applies in copyright law and is known as the \"first sale doctrine\".\nAs the Supreme Court recently explained, in Kirtsaeng v. John Wiley & Sons, Inc., 133 S. Ct. 1351 (2013), the principle comes from early English common law of property, explained in Coke on Littleton early in the 17th century. Under the common law, if a man is possessed of a chattel (item of personal property) and he transfers his property in it to another, no restriction against the use or disposition of the chattel will be effective, for that would hinder trade and commerce – it would interfere with bargaining among men. If once a patented product was sold and allowed to enter the stream of commerce, if it could be subject to restrictions (perhaps secret) on its use or further disposition, businessmen would not be able to know whether transactions in the product were effective and business certainty would be greatly impaired.\n\nFactual background\nIn 1863, U.S. Patent No. 38,713 issued to the inventors Merrill and Horner for a  coffin lid that permitted interested persons to view the name-plate and inscription of the decedent in the coffin, irrespective of whether the coffin cover is open or closed. In 1865 they assigned to Lockhart & Seelye of Cambridge. Massachusetts, the ownership of the patent in a circular area around Boston having a ten-mile radius. Adams, the plaintiff in this case, was the assignee of the patent in an area outside this circle which included the town of Natick, Massachusetts.Burke, the defendant, was an undertaker doing business in Natick, Massachusetts, seventeen miles from Boston. Burke purchased some patented coffin lids from Lockhart & Seelye, who had manufactured them. Burke then took them to Natick (more than ten miles from Boston), and used them in his business. Adams then sued him.\n\nTrial court opinion\nThe circuit court for the district of Massachusetts dismissed the case. It said:\n\nWhen a patented product passes lawfully into the hands of a purchaser without condition or restriction, it is no longer within the monopoly or under the protection of the patent act, but outside of it. ...It is clear that by such a sale the purchaser acquires an absolute title to the manufactured product which is the subject of a patent, and may deal with It in the same manner as if dealing with any other kind of property. He may use it, repair it, Improve upon it, or sell it. Subsequent purchasers acquire the same rights as the seller had, and may do with the article, or its materials, whatever the first purchaser could have lawfully done if he had not parted with the title.\n\nSupreme Court opinion\nAdams appealed to the Supreme Court, which affirmed. The Court began by observing that this was a case of first impression in the Supreme Court although the governing principle had been involved in other patent cases. That principle was this:\n\n[T]he sale by a person who has the full right to make, sell, and use . . . a machine carries with it the right to the use of that machine to the full extent to which it can be used in point of time.  . . . [I]n the essential nature of things, when the patentee, or the person having his rights, sells a machine or instrument whose sole value is in its use, he receives the consideration for its use and he parts with the right to restrict that use. The article, in the language of the Court, passes without the limit of the monopoly. [citation omitted] That is to say the patentee or his assignee having in the act of sale received all the royalty or consideration which he claims for the use of his invention in that particular machine or instrument, it is open to the use of the purchaser without further restriction on account of the monopoly of the patentees.\n\nAccordingly, the Court ruled that \"we hold that in the class of machines or implements we have described, when they are once lawfully made and sold, there is no restriction on their use to be implied for the benefit of the patentee or his assignees or licensees.\"Subsequent Supreme Court cases following the doctrine of the Adams case include:\n\nMotion Picture Patents Co. v. Universal Film Mfg. Co., 243 U.S. 502 (1917).\nStraus v. Victor Talking Machine Co., 243 U.S. 490 (1917).\nEthyl Gasoline Corp. v. United States, 309 U.S. 436 (1940).\nUnited States v. Univis Lens Co., 316 U.S. 241 (1942).\nAro Mfg. Co. v. Convertible Top Replacement Co., 365 U. S. 336 (1961).\nQuanta Computer, Inc. v. LG Electronics, Inc., 553 U.S. 617 (2008).But see:\n\nUnited States v. General Electric Co., 272 U.S. 476 (1926).\nGeneral Talking Pictures Corp. v. Western Electric Co., 304 U.S. 175 (1938).\nPassage 6:\nJones v. Cunningham\nJones v. Cunningham, 371 U.S. 236 (1963), was a Supreme Court case in which the court first ruled that state inmates had the right to file  a writ of habeas corpus challenging both the legality and the conditions of their imprisonment. Prior to this, starting with Pervear v. Massachusetts, 72 U.S. 475 (1866), the court had maintained a \"hands off\" policy regarding federal interference with state incarceration policies and practices, maintaining that the Bill of Rights did not apply to the states. Subsequently, in Cooper v. Pate (1964), an inmate successfully obtained standing to challenge the denial of his right to practice his religion through a habeas corpus writ.\nPassage 7:\nCheff v. Mathes\nCheff v. Mathes, 199 A.2d 548 (Del. 1964), was a case in which the Delaware Supreme Court first addressed the issue of director conflict of interest in a corporate change of control setting. This case is the predecessor to future seminal corporate law cases including: Unocal Corp. v. Mesa Petroleum Co., Revlon v. MacAndrews, and Paramount v. Time.\n\nFacts\nHolland Furnace Company manufactured home furnaces. The company's marketing strategy involved door-to-door sales, which employed a large workforce. This model, if not unique to Holland Furnace, was nevertheless unusual.  From the standpoint of Arnold Maremont, a businessman who had been purchasing Holland Furnace stock, it was unprofitable. These practices also implicated Holland Furnace in charges of unfair trade practices.  (An investigation of these practices by the Federal Trade Commission had already been pending for a year at the time of the events underlying the decision in Cheff.)  Sales representatives for Holland would go door to door posing as official inspectors. Claiming to be employed by the homeowner's utility or by the local government, these salesmen would disassemble the furnace, refusing to reassemble it for lack of spare parts. Holland's core business lay in replacement boilers.\nCheff-Landwehr family group had effective control over the company, with 18.5% of Holland stock. Cheff, a family member, was Holland's Chief Executive Officer. From 1948-1956, Holland's sales declined by 25%. Management attributed the sharp drop to a boom in sales following World War II, which could not be sustained in later years. Maremont, an owner of an automotive parts manufacturing business, approached Cheff in 1957 to discuss the possibility of a merger between the two companies. Cheff was not interested in a business combination.  Rebuffed, Maremont purchased 6% of Holland stock on the open market. Cheff ordered an investigation of Maremont, and learned that Maremont had engaged in corporate takeovers and liquidation of several companies. (At the resulting trial, Cheff would testify that Maremont was not well regarded among local area businessmen.)  Cheff and Maremont met a second time, by which time Maremont owned 11% of Holland Stock. Maremont told Cheff that Holland's door-to-door sales tactic was obsolete and should be abandoned in favor of a wholesaler marketing strategy.\nUpon learning of Maremont's plans, Cheffs and Holland's board of directors agreed that Maremont posed a threat to Holland's continued existence.  Holland's board would claim that Maremont's threat caused many of Holland's employees to quit in anticipation of the threatened takeover. With the stated aim of eliminating Maremont's threat to Holland's existence, the Holland board of directors authorized the repurchase of Maremont's holdings of Holland stock at a price above the prevailing market stock price. Essentially, the board authorized the payment of greenmail to Maremont.\n\nBusiness Judgment RuleThe Delaware Supreme Court first had to determine whether Holland's directors were protected from judicial scrutiny of their actions under the business judgment rule.  While the business judgment rule typically protects corporate officers from judicial scrutiny of their actions, the rule could be limited if judges found a conflict of interest.  In the case of Holland Furnace, the board's purchase of shares with corporate funds prevented a hostile takeover (which could have been in the best interest of the company) while also maintaining their control of the company. Thus, the court had to decide whether the Board was so conflicted that they should not be afforded Business Judgment Rule protection.\n\nThreat to Corporate Policy\"The question then presented is whether or not [the board] satisfied the burden of proof of showing reasonable grounds to believe a danger to corporate policy and effectiveness existed by the presence of the Maremont stock ownership. It is important to remember that the directors satisfy their burden by showing good faith and reasonable investigation; the directors will not be penalized for an honest mistake of judgment, if the judgment appeared reasonable at the time the decision was made.\"\n\nJudgment\nThe court held that the directors were protected by the business judgment rule, because they held a good faith belief that Maremont posed a threat to Holland's continued existence. Testimony established the board's understanding of Maremont's reputation for acquiring businesses and liquidating them, and that Maremont's apparent intentions negatively affected Holland's work force.\nTherefore, after Delaware's holding in this case, a director could rebut any inference of a conflict of interest, and remain protected by the business judgment rule, if they showed that they held a good faith belief that they were pursuing a \"business purpose\" that would benefit the corporation.\n\nAftermath\nThe court's findings mention - and minimize - the FTC investigation of Holland Furnace. The court, endorsing Holland's board, also notes that Holland's downward sales-trend reversed itself in 1957, the year that Maremont was bought out. What the court does not mention is that Holland's fortunes suffered another reversal - this one fatal. Holland's sales were in excess of $31 million in 1958, but dropped to $1.1 million by 1965. That year, Holland stock reached a high of $1.63 per share, compared to a closing price of $11–1/8 per share in October 1957. Holland Furnace, listed in editions of Moody's Industrial Manual for the years covering the events of this case, did not appear in 1966.\nHolland Furnace faced charges of unfair trade practices that were known prior to the decision in Cheff v. Mathes. As a result of their investigations into the sales practices of Holland Furnace, the FTC issued a \"cease and desist order\" against the company, an order upheld by the United States Court of Appeals, Seventh Circuit. Ultimately, Holland Furnace and Mr. Cheff were held in contempt for violating the order by continuing to engage in unfair trade practices. Mr. Cheff went to jail for 6 months.The unsavory character of Arnold Maremont is a key factor in the court's decision. During proceedings leading up to the court's decision in Cheff, Mr. Cheff testified as to Maremont's reputation, that: \"Throughout the whole of the Kalamazoo-Battle Creek area, and Detroit too, where I spent considerable time, he is well known and not highly regarded by any stretch.\"\nArnold Maremont, who died in 1978, involved himself in pursuits other than business. According to his obituary in The New York Times, Maremont was both a patron of the arts and a visionary for social justice. A governing life member of the Art Institute of Chicago and a former trustee of the Lyric Opera and Ballet Theater, Maremont was the first Illinois industrialist to back a law ending employment discrimination against African Americans. As chairman of the Illinois Public Aid Commission in the early 1960s, he campaigned for publicly supported birth control for welfare families.\n\nSee also\nWeinberger v. UOP, Inc. 457 A.2d 701 (Del. 1983)\nUnocal v. Mesa\nPassage 8:\nGates v. Collier\nGates v. Collier, 501 F.2d 1291 (5th Cir. 1974), was a landmark decision of the Fifth Circuit Court of Appeals that brought an end to the trusty system as well as flagrant inmate abuse at Mississippi State Penitentiary, also known as Parchman Farm, in Sunflower County, Mississippi. It was the first case in a body of law developed in the Fifth Circuit Court of Appeals holding that a variety of forms of corporal punishment against prisoners constituted cruel and unusual punishment and a violation of Eighth Amendment rights. This case was also the first broad-scale intervention by a court in the supervision of prison practices.In Gates v. Collier, the Court of Appeals found certain forms of corporal punishment violate the Eighth Amendment, including \"handcuffing inmates to the fence and to cells for long periods of time, ... and forcing inmates to stand, sit or lie on crates, stumps, or otherwise maintain awkward positions for prolonged periods.\"\n\nParchman Farm\nThe Mississippi State Penitentiary, commonly known as Parchman Farm, was founded in 1904 and consisted of 20,000 acres of delta. The prison was styled after plantations, emerging in the South during the Jim Crow era. It's estimated that throughout its history, about 90% of Parchman's prisoners were black men.After the Civil War, Mississippi was still dependent upon black labor to sustain its farms and plantations. As a result, the state passed a series of laws that made vagrancy a crime; African Americans had to constantly carry papers around showing proof of employment, and if they were found without documentation they would be arrested. Pig laws also played a role in the convictions of many Parchman Farm inmates. Pig laws made any kind of minor larceny a serious crime, for stealing something like a soda would typically result in five years of jail. Convict leasing was another discriminatory system used in which African Americans would be leased to do work rather than sent to jail, essentially taking the place of slavery.Parchman Farm had black camps that were overseen by a white sergeant. Below the white sergeant were black trusties, who had been convicted of murder and allowed to carry a gun. The state rationalized this system economically, for hiring inmates to carry out duties rather than civilian guards meant money was being saved.\"The Penitentiary Board at the time was composed of 5 individuals appointed by the Governor with consent of the Senate for 4-year terms, appointed the superintendent, who was vested with exclusive management and control of the prison system in all aspects, including the care and treatment of inmates and the hiring, control and discharge of 150 civilian employees\".Oshinksy, the author of Worse than Slavery, once stated in an interview with The Washington Post that \"Parchman Farm was basically the leading cash cow for the state of Mississippi.\" They were adding hundreds of thousands of dollars and then millions of dollars to the state treasury, and thus were a huge economic asset\".\n\nRoy Haber\nIn 1970, Roy Haber, a civil rights lawyer, was recruited along with other lawyers to \"bring some law and order to the South\".Haber first came to Parchman in 1970 after quitting his New York City divorce practice to speak with Matthew Winter, a prisoner who had been convicted of murder. Haber's initial visit to Parchman was made in order to determine whether or not Winter had been adequately represented in court. After his first meeting with Haber, Winter was threatened and beaten by trusties.Haber took statements from Parchman inmates about conditions at the prison, which was not easy at first; many prisoners were afraid of facing retribution from prison officials.Some of his most \"damning\" evidence included a document that ran over fifty single-spaced pages with a list of murders, rapes, beatings, and tortures at Parchman between 1969 and 1971.\n\nRacial discrimination and inmate abuse\nAt Parchman Farm, punishments up until the 1970s were representative of slavery. \"The prisoners were housed in large barracks that were rundown and filthy, with 100–120 in one room\". Each camp had open ditches that held raw sewage and medical waste. When Judge Keady of the District Court Case visited Parchman on multiple occasions, he witnessed \"filthy bathrooms, rotting mattresses, polluted water supplies, and kitchens overrun with insects, rodents, and the stench of decay.\" Parchman was known to be dangerous and deadly. Aside from its inhumane conditions, shootings and beatings were carried out regularly, murders failed to be documented and the maximum-security unit was a torture chamber.Allegations of abuse between 1969 and 1971 include:\n\nBogard, William: compelled to stand in the daytime and sit at night for three entire days without interruption on a coke crate.\nCollins, Matthew: murdered by trusty J.C. Dunnican on order of Ollis Hitt.\nGoodwin, Frank: \"jumped on\" and had an ear ripped off by inmate Danny Williamson.\nHayes, Jessie: shot by trusty John Horn for refusal to engage in homosexual acts.\nHumes, George: handcuffed to bars, on tiptoes for two days without food, water, or bathroom facilities.\nMarino, Hilliard: hair cut and pulled out while forced to kneel on the concrete floor, assaulted with others in MSU with brass knuckles, causing blindness and constant pain.\nNathan, Walter: handcuffed and hung from tree.\nTackett, Bob: another inmate named Cantrell kicked out one of his eyes which was lost; that he was beaten by a trusty.\nWaldie, Donald: Required to maintain a mid-suspended position which one assumes during course of doing push-ups, and at that time was guarded by J.D. Gilmer, who shot above or below him if he moved.\nWells, William: fatally shot by Sgt. West.\nWilliams, Jessie: fatally shot by Walter Griffin, a trusty, on orders of Obar, the driver of the vehicle.\n\nDistrict court case\nOn February 8, 1971, Nazareth Gates, Willie Holmes, Matthew Winter, and Hal Zachary filed a class action against the Superintendent of the Penitentiary, the members of the Mississippi Penitentiary Board and the Governor of the State. \"The plaintiffs charged that ‘deplorable conditions and practices’ at Parchman deprived them of rights guaranteed by the First, Eighth, Thirteenth, and Fourteenth amendments to the United States Constitution\".Thomas D. Cook was the penitentiary superintendent accused of committing the actions, and was replaced in February 1972 by John Collier, who was substituted and appointed in his stead as a defendant.\n\"28 U.S.C. §§ 1331 and 1343, the plaintiffs allege that the defendants, by their methods of prison administration, have deprived the inmates of rights, privileges and immunities secured to them by the First, Eighth, Thirteenth and Fourteenth Amendments and by 42 U.S.C. §§ 1981, 1983, 1985 and 1994. The complaint stated that African American inmates had been segregated and discriminated against based on their race, which is a violation of the Equal Protection Clause of the Fourteenth Amendment. The complaint aimed for injunctive relief to remedy the alleged misconduct of the defendants and a declaratory judgment that the continuation of certain practices and conditions at the penitentiary is unconstitutional\".According to a section of the Preliminary Statement, \"On August 23, 1971, the United States was allowed to intervene as plaintiff pursuant to 42 U.S.C. § 2000h-2.[2] The complaint in intervention alleges that the defendants have, contrary to the Fourteenth Amendment, maintained a system of prison facilities segregated by race; and, additionally, the defendants have failed to provide the inmates with adequate housing, medical care, and protection from assault from other prisoners; that the conditions of the sewerage disposal and water systems create an immediate health hazard, and that prison officials have permitted the custodial staff, including inadequately trained armed trusties, to inflict cruel and unusual punishment upon inmates in violation of the Eighth Amendment. The United States seeks injunctive relief to remedy the alleged misconduct of defendants\".In October 1972, Judge William Keady found for the plaintiffs, calling Parchman Farm an \"affront to modern standards of decency\" and its living quarters \"unfit for human habitation.\" He ordered an end to all unconstitutional conditions and practices.\n\nFifth Circuit decision\nThe state of Mississippi appealed this decision to the Fifth Circuit Court of Appeals, though the Fifth Circuit ended up agreeing with the lower court's earlier decision. Racial segregation of inmates was abolished as well as the trusty system.Subsequently, other states utilizing the trusty system, such as Arkansas, Alabama, Louisiana and Texas were also forced to abolish it under the Gates v. Collier rulings.\n\nSee also\nLouisiana State Penitentiary\nCummins Unit - Arkansas and Texas\nPervear v. Massachusetts\nHolt v. Sarver\nRuiz v. Estelle - Texas\nHope v. Pelzer\nPassage 9:\nWN Hillas &amp; Co Ltd v Arcos Ltd\nWN Hillas & Co Ltd v Arcos Ltd [1932] UKHL 2 is a landmark House of Lords case on English contract law where the court first began to move away from a strict, literal interpretation of the terms of a contract, and instead interpreted it with a view to preserve the bargain. The Court ruled that judges may imply terms into a contract based on the past dealings of the parties rather than void the agreement.\nLord Wright stated in this case that people who give good consideration can bind themselves to a duty to negotiate in good faith, but this view was controversially rejected in a later House of Lords case, Walford v Miles (1992).Hillas & Company were merchants purchasing timber from Arcos. Hillas and Arcos reached an agreement to purchase 22,000 standards of timber, under the specific condition that they should also have the option of entering into a contract with Arcos to purchase 100,000 standards the following year with a 5% reduction on price. Arcos refused to sell them the 100,000 standards the following year. Hillas was successful at trial, which Arcos appealed successfully to the Court of Appeal.\n\nSee also\nG Scammell & Nephew Ltd v Ouston [1941] 1 AC 251\nSmith v Hughes (1871) LR 6 QB 597\nHartog v Colin & Shields [1939] 3 All ER 566\nFrederick E Rose (London) Ltd v William H Pim Junior & Co Ltd [1953] 2 QB 450\n\nNotes\nExternal links\nFull text of decision from Bailii.org\nPassage 10:\nFletcher v. Peck\nFletcher v. Peck, 10 U.S. (6 Cranch) 87 (1810), was a landmark United States Supreme Court decision in which the Supreme Court first ruled a state law unconstitutional. The decision created a growing precedent for the sanctity of legal contracts and hinted that Native Americans did not hold complete title to their own lands (an idea fully realized in Johnson v. McIntosh).\n\nYazoo lands sales\nFollowing the Treaty of Paris ending the American Revolution, Georgia claimed possession of the Yazoo lands, a 54,000 sq mi (140,000 km2) region of the Indian Reserve, west of its own territory. The land later became the northern part of the states of Alabama and Mississippi.\nIn 1795, the Georgia legislature divided the area into four tracts. The state then sold the tracts to four separate land development companies for $500,000, about $0.014 per acre, a bargain even at 1790 prices. The Georgia legislature overwhelmingly approved this land grant, known as the Yazoo Land Act of 1795. However, it was later revealed that the Yazoo Land Act had been approved in return for bribes in a scandal known as the Yazoo Land Scandal. The voters rejected most of the incumbents in the next election; the new legislature, reacting to the public outcry, repealed the law and voided the transactions made under it.\nRobert Fletcher and especially John Peck were speculators in the Yazoo lands. Fletcher bought a tract of land from Peck after the 1795 act was repealed. Fletcher, in 1803, brought a suit against Peck, claiming that Peck had not had clear title to the land when he sold it.\nThere was collusion between the two. Both would have their land secured if the Supreme Court decided that Native Americans did not hold original title. Fletcher set out to win the case.\n\nCourt ruling\nThe Supreme Court unanimously (with a separate concurring opinion written by William Johnson) ruled that the legislature's repeal of the law was unconstitutional. John Marshall wrote that the sale was a binding contract, which under Article I, Section 10, Clause I (the Contract Clause) of the Constitution, cannot be invalidated even if it is illegally secured.\nThe ruling lent further protection to property rights against popular pressure and is the earliest case of the Court asserting its right to invalidate state laws which are in conflict with or are otherwise contrary to the Constitution. A later Chief Justice, William H. Rehnquist, wrote that Fletcher v. Peck \"represented an attempt by Chief Justice Marshall to extend the protection of the contract clause to infant business\".\n\nSee also\nList of United States Supreme Court cases, volume 10\nYazoo land scandal\n\nAnswer the question based on the given passages. Only give me the answer and do not output any other words.\n\nQuestion: Which case was brought to court first Miller v. California or Gates v. Collier ?\nAnswer:"
text = "What is your name? My name is John"
inputs = tokenizer(text, return_tensors="pt").to(model.device)
tokenized_text = [tokenizer.decode(token) for token in inputs.input_ids[0]]

# 추론 실행 (Hook이 실행됨)
with torch.no_grad():
    _ = model(**inputs)

# 훅 제거
for h in hook_handles:
    h.remove()

import pdb; pdb.set_trace()